<link rel="import" href="../../bower/polymer/polymer.html">
<link rel="import" href="../../bower/core-signals/core-signals.html">
<link rel="import" href="../../bower/core-header-panel/core-header-panel.html">
<link rel="import" href="../../bower/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../../bower/core-toolbar/core-toolbar.html">
<link rel="import" href="../../bower/core-icon-button/core-icon-button.html">
<link rel='import' href='../../bower/paper-dialog/paper-action-dialog.html'>
<link rel="import" href="../../bower/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower/paper-toast/paper-toast.html">
<link rel="import" href="../../bower/core-tooltip/core-tooltip.html">
<link rel="import" href='splash.html'>
<link rel="import" href='roster.html'>
<link rel="import" href='settings.html'>
<link rel="import" href='confirm.html'>
<link rel="import" href='logs.html'>
<link rel='import' href='copypaste.html'>
<link rel='import' href='bubble.html'>
<link rel='import' href='feedback.html'>
<link rel='import' href='reconnect.html'>
<link rel='import' href='troubleshoot.html'>
<link rel='import' href='browser-elements.html'>

<polymer-element name='uproxy-root' attributes='model' on-update-view='{{ updateView }}' on-open-dialog='{{ openDialog }}'>

  <template>
    <style>
      :host {
        font-family: Roboto, sans-serif;
        text-align: left;
        color: rgb(112, 112, 112);
      }
      paper-tab {
        cursor: pointer;
      }
      paper-tabs::shadow #selectionBar {
        /*
         * we are seeing an issue with the bar when initially loading it where
         * the width will be set to 0 since the actual buttons are not rendered
         * yet, this will cause the default to be 50% instead of 0
         */
        width: 50%;
        background-color: #20F1DE;
      }
      paper-tab::shadow #ink {
        color: #20F1DE;
        opacity: .4;
      }
      paper-tab::shadow .tab-content{
        font-size: 14px;
        text-transform: uppercase;
      }
      core-drawer-panel {
        overflow: auto;
      }
      core-header-panel {
        height: 100%;
      }
      core-header-panel::shadow #dropShadow {
        box-shadow: inset 0px 5px 6px -3px rgba(0,0,0,0.13);
      }
      core-toolbar {
        height: 105px;
        background-color: #009688;
        width: 100%;
        color: #FFFFFF;
      }
      core-toolbar::shadow #topBar {
        padding: 0px;
        height: 60px;
      }
      core-icon[icon="menu"] {
        margin: 0px 0px 0px 16px;
        opacity: 0.6;
        -webkit-transition: all 0.23s !important;
        -moz-transition: all 0.23s !important;
        transition: all 0.23s !important;
      }
      core-icon[icon="menu"]:hover {
        opacity: 1;
        cursor: pointer;
      }
      #title {
        font-size: 20px;
        margin: 0px 0px 0px 36px;
      }
      .materialDesignIcon {
        font-family: 'Material Icons';
        text-rendering: optimizeLegibility;
        font-style: normal;
        text-transform: none;
        font-size: 24px; /* preferred icon size */
        color: #006A5A;
      }
      #sharingEnabledIcon {
        margin: 0px 15px 0px  0px;
        padding: 0px;
        height: 20px;
        width: 20px;
        cursor: pointer;
      }
      #settings {
        top: 0;
      }
      #rosterContainer {
        height: 100%;
      }
      .roster {
        position: relative;
        overflow-y: auto;
        display: block;
      }
      #roster-panel {
        overflow: auto;
      }
      #status {
        width: 100%;
      }
      .statusRow {
        height: 58px;
        background-color: #283230;
      }
      .statusText {
        color: #fff;
        padding-left: 20px;
        padding-right: 20px;
        padding-top: 19px;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
        font-size: 14px;
      }
      .statusText img {
        vertical-align: middle;
        padding-right: 20px;
        width: 19px;
        height: 19px;
      }
      uproxy-bubble {
        z-index: 1;
        font-size: 13px; /* reset to normal, core-toolbar interferes with font sizes */
      }
      paper-button[class=dialogButton] {
        background-color: #009688; /* teal */
        color: white;
        margin-bottom: 3px;
      }
      paper-action-dialog {
        top: 20%;
        z-index: 1002; /* Must be greater than core-overlay-backdrop */
      }
      paper-toast {
        position: fixed;
        left: 12px;
        right: 12px;
        background-color: #283230;
        padding: 16px 16px 12px 20px;
        font-size: 12px;
      }
      #toastHelpLink {
        color: #47B5AA;
      }
      .core-overlay-backdrop {
        z-index: 1001;
      }
    </style>

    <core-signals on-core-signal-close-settings="{{ closeSettings }}"></core-signals>

    <div id='browserElementContainer' hidden?='{{ui_constants.View.BROWSER_ERROR !== ui.view}}'></div>

    <uproxy-copypaste id='copypaste' hidden?='{{ ui_constants.View.COPYPASTE !== ui.view }}'>
    </uproxy-copypaste>

    <uproxy-feedback></uproxy-feedback>

    <uproxy-splash id='splash' hidden?='{{ui_constants.View.SPLASH!=ui.view}}'>
    </uproxy-splash>

    <core-drawer-panel id='mainPanel' forceNarrow='true' drawerWidth='300px'
        hidden?='{{ ui.view !== ui_constants.View.ROSTER }}'>
      <core-header-panel drawer>
        <div class='content' fit>
          <uproxy-settings id='settings' displayAdvancedSettings='{{ displayAdvancedSettings }}'></uproxy-settings>
        </div>
      </core-header-panel>
      <core-header-panel main
          hidden?='{{ ui.view !== ui_constants.View.ROSTER }}'>

        <core-toolbar>

          <core-icon icon="menu" core-drawer-toggle></core-icon>
          <div id='title' flex>uProxy</div>

          <uproxy-bubble class='error' active='{{ ui.copyPasteError === ui_constants.CopyPasteError.LOGGED_IN }}' on-closed='{{ dismissCopyPasteError }}'>
            <h3>Cannot open manual connection</h3>
            <p>
              It is not currently possible to open a manual connection at the
              same time as being signed in to a social network.  To launch a
              manual connection, please log out through the settings menu and
              re-paste the link.
            </p>
          </uproxy-bubble>

          <core-tooltip id='statsTooltip' label='You are sharing anonymous stats.' position='left'>
            <i class='materialDesignIcon' hidden?='{{ !model.globalSettings.statsReportingEnabled }}' on-tap='{{ statsIconClicked }}'>drive_fusiontable</i>
          </core-tooltip>

          <uproxy-bubble on-closed='{{ closeStatsBubble }}' active='{{ model.globalSettings.statsReportingEnabled && statsHelpTextOpen }}'>
            <h3>Anonymous stats enabled</h3>
            <p>This icon means you have opted in to sharing anonymous statistics with the uProxy team. Click to adjust settings.</p>
          </uproxy-bubble>

          <core-tooltip label='You are available for sharing.' position='left'>
            <img id='sharingEnabledIcon'
              src='../icons/sharing-enabled-toolbar.png'
              hidden?='{{model.contacts.shareAccessContacts.onlineTrustedUproxy.length==0 && model.contacts.shareAccessContacts.offlineTrustedUproxy.length==0}}'
              on-tap='{{ setShareMode }}'></img>
          </core-tooltip>

          <uproxy-bubble on-closed='{{ closedSharing }}' active='{{ !model.globalSettings.hasSeenSharingEnabledScreen && (model.contacts.shareAccessContacts.onlineTrustedUproxy.length > 0 || model.contacts.shareAccessContacts.offlineTrustedUproxy.length > 0) }}'>
            <h3>Sharing Enabled</h3>
            <p>This icon means you're available for sharing access with friends you've offered access to.</p>
          </uproxy-bubble>

          <div class='bottom fit'>
            <paper-tabs id='modeTabs' selected='{{ model.globalSettings.mode }}' on-core-activate='{{ tabSelected }}'>
              <paper-tab>Get Access</paper-tab>
              <paper-tab>Share Access</paper-tab>
            </paper-tabs>
          </div>
        </core-toolbar>

        <uproxy-bubble on-closed='{{ closedWelcome }}' active='{{ !model.globalSettings.hasSeenWelcome && !statsHelpTextOpen }}'>
          <h3>Welcome to uProxy!</h3>
          <p>
            To get started, choose "Get access" or "Share access" and then click
            on a friend to connect.
          </p>
        </uproxy-bubble>

        <div class='content' fit>

          <div id='rosterContainer' vertical layout>
            <div id='roster-panel' flex>
              <uproxy-roster id='get-roster' class='roster'
                  hidden?='{{model.globalSettings.mode!=ui_constants.Mode.GET}}'
                  contacts='{{model.contacts.getAccessContacts}}'>
              </uproxy-roster>
              <uproxy-roster id='share-roster' class='roster'
                  hidden?='{{model.globalSettings.mode!=ui_constants.Mode.SHARE}}'
                  contacts='{{model.contacts.shareAccessContacts}}'>
              </uproxy-roster>
            </div>

            <div id='status'>
              <div class='statusRow' hidden?='{{!ui.gettingStatus}}'>
                <div class='statusText'><img src='../icons/getting.png'>{{ui.gettingStatus}}</div>
              </div>
              <div class='statusRow' hidden?='{{!ui.sharingStatus}}'>
                <div class='statusText'><img src='../icons/sharing.png'>{{ui.sharingStatus}}</div>
              </div>
            </div>
          </div>
        </div>
      </core-header-panel>
    </core-drawer-panel>

    <!-- Dialog is opened when .toggle() is called in openDialog -->
    <!-- Without layered="false", styling needs to be prefixed with 'html /deep/' in order to have effect on the dialog contents.'  -->
    <paper-action-dialog backdrop layered="false" heading="{{ dialog.heading }}" id="dialog">
      <p>{{ dialog.message }}</p>
      <template repeat='{{ button in dialog.buttons }}'>
        <paper-button
          affirmative?='{{ !button.dismissive }}' dismissive?='{{ button.dismissive }}'
          class='dialogButton' on-tap='{{ dialogButtonClick }}' data-signal='{{ button.signal }}'>
          {{button.text}}
        </paper-button>
      </template>
    </paper-action-dialog>

    <paper-action-dialog id='statsDialog' backdrop layered="false" heading="Welcome to uProxy" id="dialog">
      <p>This is an alpha release of uProxy. You can help us improve uProxy by sharing anonymous metrics with the development team. Data reported is anonymized by the client and transmitted securely. <uproxy-faq-link anchor='doesUproxyLogData'>More information.</uproxy-faq-link> You can change your choice at any time, from the Settings menu.</p>
      <p>Would you like to enable anonymous metrics collection?</p>
      <paper-button affirmative class='dialogButton' on-tap='{{ enableStats }}'>I'm in</paper-button>
      <paper-button dismissive class='dialogButton' on-tap='{{ disableStats }}'>No thanks</paper-button>
    </paper-action-dialog>

    <uproxy-troubleshoot titleText='{{ troubleshootTitle }}'></uproxy-troubleshoot>

    <paper-toast id='toast'
        opened='{{ messageNotNull(ui.toastMessage) }}'
        text='{{ ui.toastMessage }}' responsiveWidth='320px'
        style='bottom: {{ topOfStatuses(ui.gettingStatus, ui.sharingStatus) }}px;'>
      <div id='toastHelpLink' on-tap="{{ openTroubleshoot }}"
          hidden?='{{ !stringMatches(ui.toastMessage, user_interface.GET_FAILED_MSG) && !stringMatches(ui.toastMessage, user_interface.SHARE_FAILED_MSG) }}'>GET HELP
      </div>
    </paper-toast>

    <uproxy-reconnect></uproxy-reconnect>

  </template>

  <script src='root.js'></script>

</polymer-element>
